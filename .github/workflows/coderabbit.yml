name: Azure AI Code Review
 
on:
  pull_request_target:
    types: [opened, synchronize]
 
permissions:
  contents: read
  pull-requests: write
  issues: write
 
jobs:
  ai_review:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout base repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          fetch-depth: 0
 
      - name: Fetch PR head
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          git fetch origin refs/pull/$PR_NUMBER/head:pr-head
 
      - name: Generate PR diff
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          git diff "$BASE_SHA"...pr-head > diff.txt
          wc -l diff.txt
 
      - name: Chunk diff
        run: |
          mkdir -p chunks
          split -l 400 diff.txt chunks/diff_
 
      - name: Send chunks to Azure AI
        run: |
          cat <<'PROMPT' > prompt.txt
          You are a senior software engineer acting as an automated code reviewer
          similar to CodeRabbit.
 
          Your goal:
          - Help developers improve code quality
          - Be precise, constructive, and actionable
          - Avoid unnecessary criticism
 
          Review rules:
          - Focus on bugs, security, performance, and maintainability
          - Ignore formatting-only or whitespace-only changes
          - Reference filenames and approximate line numbers when possible
          - Suggest fixes or alternatives, not just problems
 
          Output MUST be valid GitHub-flavored Markdown.
 
          Output format:
 
          ## ü§ñ AI Code Review
 
          ### üìå Summary
          - Short bullet summary of overall findings
 
          ---
 
          ### üí¨ Inline Comments (File-wise)
          For each file:
          #### `path/to/file.ext`
          - **Line X**: Description of issue
            - ‚úÖ Suggestion: Concrete improvement
 
          ---
 
          ### ‚ö†Ô∏è High-Risk Issues
          - List only serious issues (security, data loss, crashes)
          - If none, say: "No high-risk issues found."
 
          Keep it concise and developer-friendly.
          PROMPT
 
          echo "## ü§ñ AI Code Review" > combined_review.md
          echo "" >> combined_review.md
 
          for CHUNK in chunks/*; do
            RESPONSE=$(curl -s -X POST https://coderabbit-production.up.railway.app/review \
              -H "Content-Type: application/json" \
              -d "$(jq -n \
                --arg diff "$(cat "$CHUNK")" \
                --arg prompt "$(cat prompt.txt)" \
                '{diff: $diff, prompt: $prompt}')")
 
            echo "$RESPONSE" | jq -r '.review // .choices[0].message.content' >> combined_review.md
            echo -e "\n---\n" >> combined_review.md
          done
 
      - name: Comment AI review on PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY="$(cat combined_review.md)"
 
          if [ -z "$BODY" ]; then
            BODY="‚ö†Ô∏è AI review failed or returned empty response."
          fi
 
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d "$(jq -n --arg body "$BODY" '{body: $body}')"
 
      - name: Add ai-reviewed label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels \
            -d '{"labels":["ai-reviewed"]}'